<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarot API Accuracy Test</title>
</head>
<body>
    <div class="container">
        <h1>Tarot API Accuracy Test</h1>
        
        <div class="test-section">
            <h2>Basic Functionality Test</h2>
            <button onclick="testBasicFunction()">Test Create & Read Spread</button>
            <div id="basic-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>Deterministic Test</h2>
            <input type="text" id="manual-seed" placeholder="Enter seed (or leave empty for random)" />
            <button onclick="testDeterministic()">Test Same Seed = Same Result</button>
            <div id="deterministic-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>Multiple Choice Parameters</h2>
            <button onclick="testMultipleChoices()">Test Different Choose Patterns</button>
            <div id="choices-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>Stress Test</h2>
            <button onclick="testStress()" id="stress-btn">Run Stress Test (100 operations)</button>
            <div class="stats" id="stress-stats"></div>
            <div id="stress-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>URL Transmission Test</h2>
            <button onclick="testURLTransmission()">Test URL Hash Routing</button>
            <div id="url-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>Edge Cases</h2>
            <button onclick="testEdgeCases()">Test Edge Cases & Error Handling</button>
            <div id="edge-result" class="result"></div>
        </div>
    </div>

    <!-- Load required modules -->
    <script>
        // Set test mode
        window.IS_TEST = true;
    </script>
    <script src="spread.js"></script>
    <script src="main.js"></script>
    
    <script>
        // Test utilities
        function log(element, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const result = document.getElementById(element);
            result.className = `result ${type}`;
            result.textContent += `[${timestamp}] ${message}\n`;
            result.scrollTop = result.scrollHeight;
        }
        
        function clearLog(element) {
            document.getElementById(element).textContent = '';
        }
        
        // 1. Basic functionality test
        async function testBasicFunction() {
            clearLog('basic-result');
            log('basic-result', 'Testing basic create and read functionality...');
            
            try {
                // Test create spread
                const createResult = await handleCreateSpread();
                const createData = JSON.parse(createResult);
                
                if (!createData.seed) {
                    throw new Error('No seed in create response');
                }
                
                log('basic-result', `✓ Created spread with seed: ${createData.seed}`, 'success');
                
                // Test read spread
                const readResult = await handleSpreadRead(createData.seed, '0,1,2');
                const readData = JSON.parse(readResult);
                
                if (!readData.chosen || readData.chosen.length !== 3) {
                    throw new Error(`Expected 3 cards, got ${readData.chosen ? readData.chosen.length : 0}`);
                }
                
                log('basic-result', `✓ Read 3 cards successfully`, 'success');
                log('basic-result', `Cards: ${readData.chosen.map(c => c.name).join(', ')}`, 'info');
                
                // Test URL format
                if (createData.url) {
                    log('basic-result', `✓ URL provided: ${createData.url}`, 'success');
                }
                
            } catch (error) {
                log('basic-result', `✗ Error: ${error.message}`, 'error');
            }
        }
        
        // 2. Deterministic test
        async function testDeterministic() {
            clearLog('deterministic-result');
            log('deterministic-result', 'Testing deterministic behavior...');
            
            try {
                const seedInput = document.getElementById('manual-seed').value.trim();
                const seed = seedInput || generateSeed();
                
                log('deterministic-result', `Using seed: ${seed}`);
                
                // Generate same spread multiple times
                const results = [];
                for (let i = 0; i < 5; i++) {
                    const result = await handleSpreadRead(seed, '0,1,2,3,4');
                    const data = JSON.parse(result);
                    results.push(data.chosen.map(c => `${c.name}:${c.orientation}`).join('|'));
                }
                
                // Check if all results are identical
                const allSame = results.every(r => r === results[0]);
                
                if (allSame) {
                    log('deterministic-result', '✓ All 5 runs produced identical results', 'success');
                    log('deterministic-result', `Pattern: ${results[0]}`, 'info');
                } else {
                    log('deterministic-result', '✗ Results differ between runs!', 'error');
                    results.forEach((r, i) => {
                        log('deterministic-result', `Run ${i + 1}: ${r}`, 'warning');
                    });
                }
                
            } catch (error) {
                log('deterministic-result', `✗ Error: ${error.message}`, 'error');
            }
        }
        
        // 3. Multiple choice parameters test
        async function testMultipleChoices() {
            clearLog('choices-result');
            log('choices-result', 'Testing different choice parameters...');
            
            try {
                const seed = generateSeed();
                const choicePatterns = [
                    '0',
                    '0,1,2',
                    '5,10,15,20',
                    '0,1,2,3,4,5,6,7,8,9', // Celtic Cross
                    '71', // Last card
                    '0,35,71', // First, middle, last
                ];
                
                for (const pattern of choicePatterns) {
                    const result = await handleSpreadRead(seed, pattern);
                    const data = JSON.parse(result);
                    
                    const expected = pattern.split(',').length;
                    const actual = data.chosen.length;
                    
                    if (actual === expected) {
                        log('choices-result', `✓ Pattern "${pattern}": ${actual} cards`, 'success');
                    } else {
                        log('choices-result', `✗ Pattern "${pattern}": expected ${expected}, got ${actual}`, 'error');
                    }
                }
                
            } catch (error) {
                log('choices-result', `✗ Error: ${error.message}`, 'error');
            }
        }
        
        // 4. Stress test
        async function testStress() {
            clearLog('stress-result');
            document.getElementById('stress-stats').innerHTML = '';
            document.getElementById('stress-btn').disabled = true;
            
            log('stress-result', 'Running stress test (100 operations)...');
            
            const stats = {
                totalOps: 100,
                successfulCreates: 0,
                successfulReads: 0,
                errors: 0,
                totalTime: 0,
                avgSeedLength: 0,
                uniqueSeeds: new Set()
            };
            
            const startTime = performance.now();
            
            try {
                for (let i = 0; i < stats.totalOps; i++) {
                    try {
                        // Create spread
                        const createResult = await handleCreateSpread();
                        const createData = JSON.parse(createResult);
                        
                        if (createData.seed) {
                            stats.successfulCreates++;
                            stats.uniqueSeeds.add(createData.seed);
                            stats.avgSeedLength += createData.seed.length;
                            
                            // Test read
                            const readResult = await handleSpreadRead(createData.seed, '0,1,2');
                            const readData = JSON.parse(readResult);
                            
                            if (readData.chosen && readData.chosen.length === 3) {
                                stats.successfulReads++;
                            }
                        }
                        
                        // Progress update every 20 operations
                        if ((i + 1) % 20 === 0) {
                            log('stress-result', `Progress: ${i + 1}/100 operations completed`);
                        }
                        
                    } catch (error) {
                        stats.errors++;
                        log('stress-result', `Error at operation ${i + 1}: ${error.message}`, 'warning');
                    }
                }
                
                stats.totalTime = performance.now() - startTime;
                stats.avgSeedLength = stats.avgSeedLength / stats.successfulCreates || 0;
                
                // Display stats
                const statsHtml = `
                    <div class="stat">
                        <div class="stat-value">${stats.successfulCreates}</div>
                        <div class="stat-label">Successful Creates</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${stats.successfulReads}</div>
                        <div class="stat-label">Successful Reads</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${stats.errors}</div>
                        <div class="stat-label">Errors</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${stats.totalTime.toFixed(0)}ms</div>
                        <div class="stat-label">Total Time</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${stats.uniqueSeeds.size}</div>
                        <div class="stat-label">Unique Seeds</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${stats.avgSeedLength.toFixed(1)}</div>
                        <div class="stat-label">Avg Seed Length</div>
                    </div>
                `;
                
                document.getElementById('stress-stats').innerHTML = statsHtml;
                
                const successRate = ((stats.successfulReads / stats.totalOps) * 100).toFixed(1);
                log('stress-result', `✓ Stress test completed! Success rate: ${successRate}%`, 'success');
                
            } catch (error) {
                log('stress-result', `✗ Stress test failed: ${error.message}`, 'error');
            }
            
            document.getElementById('stress-btn').disabled = false;
        }
        
        // 5. URL transmission test
        async function testURLTransmission() {
            clearLog('url-result');
            log('url-result', 'Testing URL hash routing...');
            
            try {
                const seed = generateSeed();
                log('url-result', `Generated seed: ${seed}`);
                
                // Simulate different URL formats
                const urlFormats = [
                    `#spread/${seed}?choose=0,1,2`,
                    `#spread/${seed}?choose=5,10,15`,
                    `#spread/${seed}?choose=0`
                ];
                
                for (const hashFormat of urlFormats) {
                    // Simulate URL parsing
                    const hash = hashFormat.slice(1); // Remove #
                    
                    if (hash.startsWith('spread/')) {
                        let seedPart = hash.substring('spread/'.length);
                        const queryIndex = seedPart.indexOf('?');
                        let extractedSeed, hashQuery = '';
                        
                        if (queryIndex !== -1) {
                            extractedSeed = seedPart.substring(0, queryIndex);
                            hashQuery = seedPart.substring(queryIndex + 1);
                        } else {
                            extractedSeed = seedPart;
                        }
                        
                        const hashParams = new URLSearchParams(hashQuery);
                        const chooseParam = hashParams.get('choose');
                        
                        if (extractedSeed === seed) {
                            log('url-result', `✓ URL format "${hashFormat}": seed extracted correctly`, 'success');
                            log('url-result', `  Choose param: ${chooseParam}`, 'info');
                        } else {
                            log('url-result', `✗ URL format "${hashFormat}": seed mismatch`, 'error');
                            log('url-result', `  Expected: ${seed}`, 'error');
                            log('url-result', `  Got: ${extractedSeed}`, 'error');
                        }
                    }
                }
                
            } catch (error) {
                log('url-result', `✗ Error: ${error.message}`, 'error');
            }
        }
        
        // 6. Edge cases test
        async function testEdgeCases() {
            clearLog('edge-result');
            log('edge-result', 'Testing edge cases and error handling...');
            
            const testCases = [
                {
                    name: 'Empty seed',
                    seed: '',
                    choose: '0,1,2',
                    expectError: true
                },
                {
                    name: 'Invalid choose indices',
                    seed: generateSeed(),
                    choose: '100,200,300',
                    expectError: false // Should return empty array
                },
                {
                    name: 'Negative indices',
                    seed: generateSeed(),
                    choose: '-1,-2,-3',
                    expectError: false
                },
                {
                    name: 'Mixed valid/invalid indices',
                    seed: generateSeed(),
                    choose: '0,1,999,2,abc',
                    expectError: false
                },
                {
                    name: 'No choose parameter',
                    seed: generateSeed(),
                    choose: null,
                    expectError: false
                },
                {
                    name: 'Very long seed',
                    seed: 'a'.repeat(1000),
                    choose: '0,1,2',
                    expectError: false
                }
            ];
            
            for (const testCase of testCases) {
                try {
                    const result = await handleSpreadRead(testCase.seed, testCase.choose);
                    const data = JSON.parse(result);
                    
                    if (testCase.expectError) {
                        if (data.error) {
                            log('edge-result', `✓ ${testCase.name}: Error handled correctly`, 'success');
                        } else {
                            log('edge-result', `✗ ${testCase.name}: Expected error but got success`, 'warning');
                        }
                    } else {
                        if (data.chosen !== undefined) {
                            log('edge-result', `✓ ${testCase.name}: Handled gracefully (${data.chosen.length} cards)`, 'success');
                        } else if (data.error) {
                            log('edge-result', `? ${testCase.name}: Error returned: ${data.error}`, 'info');
                        }
                    }
                    
                } catch (error) {
                    if (testCase.expectError) {
                        log('edge-result', `✓ ${testCase.name}: Exception handled correctly`, 'success');
                    } else {
                        log('edge-result', `✗ ${testCase.name}: Unexpected exception: ${error.message}`, 'error');
                    }
                }
            }
        }
    </script>
</body>
</html>
